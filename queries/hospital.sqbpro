<?xml version="1.0" encoding="UTF-8"?><sqlb_project><db path="hospital.db" readonly="0" foreign_keys="1" case_sensitive_like="0" temp_store="0" wal_autocheckpoint="1000" synchronous="2"/><attached/><window><main_tabs open="structure browser pragmas query" current="3"/></window><tab_structure><column_width id="0" width="300"/><column_width id="1" width="0"/><column_width id="2" width="100"/><column_width id="3" width="8162"/><column_width id="4" width="0"/><expanded_item id="0" parent="1"/><expanded_item id="1" parent="1"/><expanded_item id="2" parent="1"/><expanded_item id="3" parent="1"/></tab_structure><tab_browse><table title="treatments" custom_title="0" dock_id="1" table="4,10:maintreatments"/><dock_state state="000000ff00000000fd00000001000000020000059700000381fc0100000001fb000000160064006f0063006b00420072006f00770073006500310100000000000005970000012400ffffff000002580000000000000004000000040000000800000008fc00000000"/><default_encoding codec=""/><browse_table_settings><table schema="main" name="appointments" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="96"/><column index="2" value="65"/><column index="3" value="61"/><column index="4" value="111"/><column index="5" value="111"/><column index="6" value="101"/><column index="7" value="78"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="billing" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="43"/><column index="2" value="65"/><column index="3" value="81"/><column index="4" value="85"/><column index="5" value="62"/><column index="6" value="106"/><column index="7" value="98"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="doctors" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="61"/><column index="2" value="69"/><column index="3" value="66"/><column index="4" value="93"/><column index="5" value="93"/><column index="6" value="106"/><column index="7" value="132"/><column index="8" value="226"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="patients" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="65"/><column index="2" value="69"/><column index="3" value="70"/><column index="4" value="47"/><column index="5" value="85"/><column index="6" value="99"/><column index="7" value="101"/><column index="8" value="105"/><column index="9" value="116"/><column index="10" value="112"/><column index="11" value="195"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="treatments" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="81"/><column index="2" value="96"/><column index="3" value="109"/><column index="4" value="148"/><column index="5" value="62"/><column index="6" value="96"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table></browse_table_settings></tab_browse><tab_sql><sql name="SQL 1">-- Monthly Appointments per Doctor
WITH monthly_appointments AS (
    SELECT
        d.doctor_id,
        d.first_name,
		d.last_name,
        d.specialization,
        strftime('%Y-%m', a.appointment_date) AS month,
        COUNT(a.appointment_id) AS appointment_count
    FROM appointments a
    JOIN doctors d
        ON a.doctor_id = d.doctor_id
    GROUP BY
        d.doctor_id,
        d.first_name,
		d.last_name,
        d.specialization,
        month
)
SELECT *
FROM monthly_appointments
ORDER BY month, appointment_count DESC;</sql><sql name="SQL 2">--Doctor Ranking by Workload (Monthly)
WITH monthly_appointments AS (
    SELECT
        d.doctor_id,
        d.first_name,
		d.last_name,
        d.specialization,
        strftime('%Y-%m', a.appointment_date) AS month,
        COUNT(a.appointment_id) AS appointment_count
    FROM appointments a
    JOIN doctors d
        ON a.doctor_id = d.doctor_id
    GROUP BY
        d.doctor_id,
        d.first_name,
		d.last_name,
        d.specialization,
        month
)
SELECT
    *,
    RANK() OVER (
        PARTITION BY month
        ORDER BY appointment_count DESC
    ) AS workload_rank
FROM monthly_appointments
ORDER BY month, workload_rank;
</sql><sql name="SQL 3">--Workload Variance Within Specializations
WITH monthly_appointments AS (
    SELECT
        d.doctor_id,
        d.specialization,
        strftime('%Y-%m', a.appointment_date) AS month,
        COUNT(a.appointment_id) AS appointment_count
    FROM appointments a
    JOIN doctors d
        ON a.doctor_id = d.doctor_id
    GROUP BY
        d.doctor_id,
        d.specialization,
        month
)
SELECT
    specialization,
    month,
    ROUND(AVG(appointment_count),2) AS avg_appointments,
    MAX(appointment_count) - MIN(appointment_count) AS workload_range
FROM monthly_appointments
GROUP BY specialization, month
ORDER BY month, workload_range DESC;
</sql><sql name="SQL 4">--Appointment Volume by Specialization
SELECT
    d.specialization,
    COUNT(a.appointment_id) AS total_appointments
FROM appointments a
JOIN doctors d
    ON a.doctor_id = d.doctor_id
GROUP BY d.specialization
ORDER BY total_appointments DESC;</sql><sql name="SQL 5">--Total Revenue by Specialization
SELECT
    d.specialization,
    SUM(b.amount) AS total_revenue
FROM billing b
JOIN appointments a
    ON b.patient_id = a.patient_id
JOIN doctors d
    ON a.doctor_id = d.doctor_id
GROUP BY d.specialization
ORDER BY total_revenue DESC;
</sql><sql name="SQL 6">--Revenue per Appointment by Specialization
WITH specialization_metrics AS (
    SELECT
        d.specialization,
        COUNT(DISTINCT a.appointment_id) AS appointment_count,
        SUM(b.amount) AS total_revenue
    FROM billing b
    JOIN appointments a
        ON b.patient_id = a.patient_id
    JOIN doctors d
        ON a.doctor_id = d.doctor_id
    GROUP BY d.specialization
)
SELECT
    specialization,
    appointment_count,
    total_revenue,
    ROUND(
        total_revenue * 1.0 / appointment_count,
        2
    ) AS revenue_per_appointment
FROM specialization_metrics
ORDER BY revenue_per_appointment DESC;
</sql><sql name="SQL 7">--B)  Appointment → Treatment Conversion
WITH
appt AS (
  SELECT DISTINCT appointment_id
  FROM appointments
),
treated_appt AS (
  SELECT DISTINCT appointment_id
  FROM treatments
  WHERE appointment_id IS NOT NULL
)
SELECT
  (SELECT COUNT(*) FROM appt) AS appointments,
  (SELECT COUNT(*) FROM treated_appt) AS treated_appointments,
  ROUND((SELECT COUNT(*) FROM treated_appt) * 1.0 / NULLIF((SELECT COUNT(*) FROM appt), 0), 4) AS appt_to_treatment_rate,
  ROUND(1 - ((SELECT COUNT(*) FROM treated_appt) * 1.0 / NULLIF((SELECT COUNT(*) FROM appt), 0)), 4) AS appt_dropoff;

</sql><sql name="SQL 8">-- Treatment → Billing Conversion (Patient-Level)
WITH
treated_patients AS (
    SELECT DISTINCT a.patient_id
    FROM treatments t
    JOIN appointments a
        ON a.appointment_id = t.appointment_id
),
billed_patients AS (
    SELECT DISTINCT patient_id
    FROM billing
)
SELECT
    (SELECT COUNT(*) FROM treated_patients) AS patients_with_treatment,
    (SELECT COUNT(*)
     FROM treated_patients tp
     JOIN billed_patients bp
        ON bp.patient_id = tp.patient_id
    ) AS treated_patients_with_billing,
    ROUND(
        (SELECT COUNT(*)
         FROM treated_patients tp
         JOIN billed_patients bp
            ON bp.patient_id = tp.patient_id
        ) * 1.0
        / NULLIF((SELECT COUNT(*) FROM treated_patients), 0),
        4
    ) AS treatment_to_billing_rate,
    ROUND(
        1 -
        (
            (SELECT COUNT(*)
             FROM treated_patients tp
             JOIN billed_patients bp
                ON bp.patient_id = tp.patient_id
            ) * 1.0
            / NULLIF((SELECT COUNT(*) FROM treated_patients), 0)
        ),
        4
    ) AS treatment_to_billing_dropoff;
</sql><sql name="SQL 9">--Revenue Intelligence — Revenue Decomposition
--  Revenue by Doctor

SELECT
    d.doctor_id,
    d.first_name,
    d.last_name,
    d.specialization,
    SUM(b.amount) AS total_revenue
FROM billing b
JOIN appointments a
    ON b.patient_id = a.patient_id
JOIN doctors d
    ON a.doctor_id = d.doctor_id
GROUP BY
    d.doctor_id,
    d.first_name,
    d.last_name,
    d.specialization
ORDER BY total_revenue DESC;</sql><sql name="SQL 10">--Revenue by Specialization
SELECT
    d.specialization,
    SUM(b.amount) AS total_revenue
FROM billing b
JOIN appointments a
    ON b.patient_id = a.patient_id
JOIN doctors d
    ON a.doctor_id = d.doctor_id
GROUP BY d.specialization
ORDER BY total_revenue DESC;</sql><sql name="SQL 11">--Revenue by Treatment Type
SELECT
    t.treatment_type,
    SUM(b.amount) AS total_revenue
FROM billing b
JOIN appointments a
    ON b.patient_id = a.patient_id
JOIN treatments t
    ON t.appointment_id = a.appointment_id
GROUP BY t.treatment_type
ORDER BY total_revenue DESC;
</sql><sql name="SQL 12">--Revenue Contribution Analysis
WITH specialization_revenue AS (
    SELECT
        d.specialization,
        SUM(b.amount) AS total_revenue
    FROM billing b
    JOIN appointments a
        ON b.patient_id = a.patient_id
    JOIN doctors d
        ON a.doctor_id = d.doctor_id
    GROUP BY d.specialization
),
total AS (
    SELECT SUM(total_revenue) AS grand_total
    FROM specialization_revenue
)
SELECT
    s.specialization,
    s.total_revenue,
    ROUND(
        s.total_revenue * 1.0 / t.grand_total,
        4
    ) AS revenue_share
FROM specialization_revenue s
CROSS JOIN total t
ORDER BY revenue_share DESC;
</sql><sql name="SQL 13">--Monthly Revenue by Doctor
SELECT
    d.doctor_id,
    d.first_name,
    d.last_name,
    strftime('%Y-%m', a.appointment_date) AS month,
    SUM(b.amount) AS monthly_revenue
FROM billing b
JOIN appointments a
    ON b.patient_id = a.patient_id
JOIN doctors d
    ON a.doctor_id = d.doctor_id
GROUP BY
    d.doctor_id,
    d.first_name,
    d.last_name,
    month
ORDER BY
    d.doctor_id,
    month;</sql><sql name="SQL 14">--Revenue Volatility by Doctor
WITH doctor_monthly_revenue AS (
    SELECT
        d.doctor_id,
        d.first_name,
        d.last_name,
        strftime('%Y-%m', a.appointment_date) AS month,
        SUM(b.amount) AS monthly_revenue
    FROM billing b
    JOIN appointments a
        ON b.patient_id = a.patient_id
    JOIN doctors d
        ON a.doctor_id = d.doctor_id
    GROUP BY
        d.doctor_id,
        d.first_name,
        d.last_name,
        month
)
SELECT
    doctor_id,
    first_name,
    last_name,
    ROUND(AVG(monthly_revenue), 2) AS avg_monthly_revenue,
    ROUND(MAX(monthly_revenue) - MIN(monthly_revenue), 2) AS revenue_range
FROM doctor_monthly_revenue
GROUP BY
    doctor_id,
    first_name,
    last_name
ORDER BY revenue_range DESC;
</sql><sql name="SQL 15">--Monthly Revenue by Specialization
SELECT
    d.specialization,
    strftime('%Y-%m', a.appointment_date) AS month,
    SUM(b.amount) AS monthly_revenue
FROM billing b
JOIN appointments a
    ON b.patient_id = a.patient_id
JOIN doctors d
    ON a.doctor_id = d.doctor_id
GROUP BY
    d.specialization,
    month
ORDER BY
    d.specialization,
    month;
</sql><sql name="SQL 16">--Revenue Volatility by Specialization
WITH specialization_monthly_revenue AS (
    SELECT
        d.specialization,
        strftime('%Y-%m', a.appointment_date) AS month,
        SUM(b.amount) AS monthly_revenue
    FROM billing b
    JOIN appointments a
        ON b.patient_id = a.patient_id
    JOIN doctors d
        ON a.doctor_id = d.doctor_id
    GROUP BY
        d.specialization,
        month
)
SELECT
    specialization,
    ROUND(AVG(monthly_revenue), 2) AS avg_monthly_revenue,
    ROUND(MAX(monthly_revenue) - MIN(monthly_revenue), 2) AS revenue_range
FROM specialization_monthly_revenue
GROUP BY specialization
ORDER BY revenue_range DESC;
</sql><sql name="SQL 17">--Revenue Concentration Risk (Top Providers)
WITH doctor_revenue AS (
    SELECT
        d.doctor_id,
        d.first_name,
        d.last_name,
        SUM(b.amount) AS total_revenue
    FROM billing b
    JOIN appointments a
        ON b.patient_id = a.patient_id
    JOIN doctors d
        ON a.doctor_id = d.doctor_id
    GROUP BY
        d.doctor_id,
        d.first_name,
        d.last_name
),
total AS (
    SELECT SUM(total_revenue) AS grand_total
    FROM doctor_revenue
)
SELECT
    dr.doctor_id,
    dr.first_name,
    dr.last_name,
    dr.total_revenue,
    ROUND(dr.total_revenue * 1.0 / t.grand_total, 4) AS revenue_share
FROM doctor_revenue dr
CROSS JOIN total t
ORDER BY revenue_share DESC;
</sql><sql name="SQL 18">--Patient-Level Metrics (Frequency, Monetary, Recency)
WITH patient_metrics AS (
    SELECT
        a.patient_id,
        COUNT(DISTINCT a.appointment_id) AS visit_count,
        SUM(b.amount) AS total_spend,
        MAX(a.appointment_date) AS last_visit_date
    FROM appointments a
    LEFT JOIN billing b
        ON a.patient_id = b.patient_id
    GROUP BY a.patient_id
)
SELECT *
FROM patient_metrics;</sql><sql name="SQL 19">--Patient Segmentation Logic
WITH patient_metrics AS (
    SELECT
        a.patient_id,
        COUNT(DISTINCT a.appointment_id) AS visit_count,
        SUM(b.amount) AS total_spend,
        MAX(a.appointment_date) AS last_visit_date
    FROM appointments a
    LEFT JOIN billing b
        ON a.patient_id = b.patient_id
    GROUP BY a.patient_id
),
segmented_patients AS (
    SELECT
        patient_id,
        visit_count,
        total_spend,
        last_visit_date,
        CASE
            WHEN visit_count &gt;= 5 AND total_spend &gt;= 100000 THEN 'Chronic high-frequency patients'
            WHEN visit_count &gt;= 4 AND total_spend &lt; 50000 THEN 'Frequent low-cost patients'
            WHEN visit_count &lt;= 2 AND total_spend &gt;= 80000 THEN 'Rare high-cost patients'
            ELSE 'Other patients'
        END AS patient_segment
    FROM patient_metrics
)
SELECT
    patient_segment,
    COUNT(*) AS patient_count
FROM segmented_patients
GROUP BY patient_segment
ORDER BY patient_count DESC;
</sql><sql name="SQL 20">--Monthly Appointment Trend

SELECT
    strftime('%Y-%m', appointment_date) AS month,
    COUNT(*) AS appointment_count
FROM appointments
GROUP BY month
ORDER BY month;</sql><sql name="SQL 21">--Monthly Revenue Trend
SELECT
    strftime('%Y-%m', a.appointment_date) AS month,
    SUM(b.amount) AS monthly_revenue
FROM billing b
JOIN appointments a
    ON b.patient_id = a.patient_id
GROUP BY month
ORDER BY month;
</sql><sql name="SQL 22">--Seasonality Detection
SELECT
    strftime('%m', appointment_date) AS month_of_year,
    COUNT(*) AS appointment_count
FROM appointments
GROUP BY month_of_year
ORDER BY month_of_year;


SELECT
    strftime('%m', a.appointment_date) AS month_of_year,
    SUM(b.amount) AS revenue
FROM billing b
JOIN appointments a
    ON b.patient_id = a.patient_id
GROUP BY month_of_year
ORDER BY month_of_year;
</sql><sql name="SQL 23">--Growth vs Decline Detection
WITH monthly_metrics AS (
    SELECT
        strftime('%Y-%m', a.appointment_date) AS month,
        COUNT(DISTINCT a.appointment_id) AS appointments,
        SUM(b.amount) AS revenue
    FROM appointments a
    LEFT JOIN billing b
        ON a.patient_id = b.patient_id
    GROUP BY month
)
SELECT
    month,
    appointments,
    revenue,
    appointments - LAG(appointments) OVER (ORDER BY month) AS appointment_change,
    revenue - LAG(revenue) OVER (ORDER BY month) AS revenue_change
FROM monthly_metrics
ORDER BY month;
</sql><sql name="SQL 24">--vw_doctor_monthly_performance

DROP VIEW IF EXISTS vw_doctor_monthly_performance;
CREATE VIEW vw_doctor_monthly_performance AS
WITH doctor_monthly AS (
    SELECT
        d.doctor_id,
        d.first_name,
        d.last_name,
        d.specialization,
        strftime('%Y-%m', a.appointment_date) AS month,
        COUNT(DISTINCT a.appointment_id) AS appointment_count,
        SUM(b.amount) AS monthly_revenue
    FROM appointments a
    JOIN doctors d
        ON a.doctor_id = d.doctor_id
    LEFT JOIN billing b
        ON a.patient_id = b.patient_id
    GROUP BY
        d.doctor_id, d.first_name, d.last_name, d.specialization, month
)
SELECT
    *,
    ROUND(
        monthly_revenue * 1.0 / NULLIF(appointment_count, 0),
        2
    ) AS revenue_per_appointment
FROM doctor_monthly;</sql><sql name="SQL 25">--vw_specialization_revenue
DROP VIEW IF EXISTS vw_specialization_revenue;
CREATE VIEW vw_specialization_revenue AS
WITH specialization_revenue AS (
    SELECT
        d.specialization,
        SUM(b.amount) AS total_revenue
    FROM billing b
    JOIN appointments a
        ON b.patient_id = a.patient_id
    JOIN doctors d
        ON a.doctor_id = d.doctor_id
    GROUP BY d.specialization
),
total AS (
    SELECT SUM(total_revenue) AS grand_total
    FROM specialization_revenue
)
SELECT
    s.specialization,
    s.total_revenue,
    ROUND(s.total_revenue * 1.0 / t.grand_total, 4) AS revenue_share
FROM specialization_revenue s
CROSS JOIN total t;
</sql><sql name="SQL 26">--vw_patient_value_segments
DROP VIEW IF EXISTS vw_patient_value_segments;
CREATE VIEW vw_patient_value_segments AS
WITH patient_metrics AS (
    SELECT
        a.patient_id,
        COUNT(DISTINCT a.appointment_id) AS visit_count,
        SUM(b.amount) AS total_spend,
        MAX(a.appointment_date) AS last_visit_date
    FROM appointments a
    LEFT JOIN billing b
        ON a.patient_id = b.patient_id
    GROUP BY a.patient_id
)
SELECT
    patient_id,
    visit_count,
    total_spend,
    last_visit_date,
    CASE
        WHEN visit_count &gt;= 5 AND total_spend &gt;= 100000 THEN 'Chronic high-frequency patients'
        WHEN visit_count &gt;= 4 AND total_spend &lt; 50000 THEN 'Frequent low-cost patients'
        WHEN visit_count &lt;= 2 AND total_spend &gt;= 80000 THEN 'Rare high-cost patients'
        ELSE 'Other patients'
    END AS patient_segment
FROM patient_metrics;
</sql><sql name="SQL 27">--vw_appointment_to_billing_funnel
DROP VIEW IF EXISTS vw_appointment_to_billing_funnel;
CREATE VIEW vw_appointment_to_billing_funnel AS
WITH
appt AS (
  SELECT DISTINCT appointment_id, patient_id
  FROM appointments
),
treated_appt AS (
  SELECT DISTINCT appointment_id
  FROM treatments
  WHERE appointment_id IS NOT NULL
),
treated_patients AS (
  SELECT DISTINCT a.patient_id
  FROM treatments t
  JOIN appointments a
    ON a.appointment_id = t.appointment_id
),
billed_patients AS (
  SELECT DISTINCT patient_id
  FROM billing
),
metrics AS (
  SELECT
    (SELECT COUNT(DISTINCT appointment_id) FROM appt) AS appointments,
    (SELECT COUNT(DISTINCT appointment_id) FROM treated_appt) AS treated_appointments,
    (SELECT COUNT(DISTINCT patient_id) FROM treated_patients) AS patients_with_treatment,
    (SELECT COUNT(*)
     FROM treated_patients tp
     JOIN billed_patients bp
       ON bp.patient_id = tp.patient_id) AS treated_patients_with_billing
)
SELECT
  appointments,
  treated_appointments,
  ROUND(treated_appointments * 1.0 / NULLIF(appointments, 0), 4) AS appt_to_treatment_rate,
  ROUND(1 - (treated_appointments * 1.0 / NULLIF(appointments, 0)), 4) AS appt_dropoff,
  patients_with_treatment,
  treated_patients_with_billing,
  ROUND(treated_patients_with_billing * 1.0 / NULLIF(patients_with_treatment, 0), 4) AS treatment_to_billing_rate,
  ROUND(1 - (treated_patients_with_billing * 1.0 / NULLIF(patients_with_treatment, 0)), 4) AS treatment_to_billing_dropoff
FROM metrics;
</sql><sql name="SQL 28">--use views
-- Top doctors by monthly revenue
SELECT * FROM vw_doctor_monthly_performance
ORDER BY monthly_revenue DESC
LIMIT 10;

-- Specialization revenue and share
SELECT * FROM vw_specialization_revenue
ORDER BY revenue_share DESC;

-- Patient segments distribution
SELECT patient_segment, COUNT(*) AS n
FROM vw_patient_value_segments
GROUP BY patient_segment
ORDER BY n DESC;

-- Funnel KPIs
SELECT * FROM vw_appointment_to_billing_funnel;
</sql><current_tab id="27"/></tab_sql></sqlb_project>
